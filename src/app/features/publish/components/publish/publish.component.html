<div class="publish-page">
  <app-header [publishing]="true"></app-header>

  <main class="publish-main">
    <!-- ========== PASO 1 ========== -->
    <app-publish-type-step
      *ngIf="progress.currentStep === 1"
      (continue)="nextStep()"
    >
    </app-publish-type-step>

    <!-- ========== PASO 2 ========== -->

    <div class="step-header" *ngIf="progress.currentStep === 2">
      <span class="step-indicator">Paso 2 de 3</span>
      <h1 class="step-title">Completá los datos del producto</h1>
    </div>
    <section *ngIf="progress.currentStep === 2">
      <form id="detailsForm" [formGroup]="detailsForm" class="details-form">
        <!-- Título -->
        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 0"
          [disabled]="cardDisabled(0)"
          title="Título"
          description="Nombre completo y claro del producto"
          [continueDisabled]="detailsForm.get('title')!.invalid"
          [showFooter]="true"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <app-form-field
            placeholder="Ej: Sillón de 3 cuerpos de cuero"
            formControlName="title"
            [disabled]="cardDisabled(0)"
            [hasError]="hasError('details', 'title')"
            [errorMessage]="getError('details', 'title')"
          >
          </app-form-field>
        </app-publish-info>

        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 1"
          [disabled]="cardDisabled(1)"
          title="Categorías"
          description="Selecciona la/s categoría/s en la que se encontrara tu producto"
          [continueDisabled]="categories[0].idPath == ''"
          [showFooter]="true"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <div class="categories-container">
            <div class="cat-slot" #slot 
              *ngFor="let cat of categories; let i = index">

              <app-button-categories
                [categoryName]="cat.name || null"
                (toggle)="onToggle(i)"
                [disabled]="cardDisabled(1)"
                (clear)="onClear(i)"
              >
              </app-button-categories>

              <div
                *ngIf="showList[i]"
                class="dropdown-wrapper"
                (click)="$event.stopPropagation()"
              >
                <!-- evita cierre -->
                <app-list-categories
                  (categorySelected)="onCategorySelected(i, $event)"
                >
                </app-list-categories>
              </div>
            </div>
          </div>
        </app-publish-info>

        <!-- Descripción -->
        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 2"
          title="Descripción"
          [disabled]="cardDisabled(2)"
          description="Contá con más detalle qué vendés"
          [continueDisabled]="detailsForm.get('description')!.invalid"
          [showFooter]="true"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <app-form-field
            type="textarea"
            [rows]="4"
            [disabled]="cardDisabled(2)"
            placeholder="Características, medidas, etc."
            formControlName="description"
            [hasError]="hasError('details', 'description')"
            [errorMessage]="getError('details', 'description')"
          >
          </app-form-field>
        </app-publish-info>

        <!-- Marca -->
        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 3"
          title="Marca"
          [disabled]="cardDisabled(3)"
          description="Ingresa la marca de tu producto"
          [showFooter]="true"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <app-form-field formControlName="brand" [disabled]="cardDisabled(3)">
          </app-form-field>
        </app-publish-info>

        <!-- Condición -->
        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 4"
          [disabled]="cardDisabled(4)"
          title="Condición"
          description="Especifica si el producto es nuevo o usado"
          [showFooter]="true"
          [continueDisabled]="detailsForm.get('condition')!.invalid"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <app-form-field
            type="radio"
            formControlName="condition"
            [disabled]="cardDisabled(4)"
            [options]="[
              { value: 2, label: 'Nuevo' },
              { value: 1, label: 'Usado' }
            ]"
            [hasError]="hasError('details', 'condition')"
            [errorMessage]="getError('details', 'condition')"
          >
          </app-form-field>
        </app-publish-info>

        <!-- Fotos -->
        <app-publish-info
          [formId]="'detailsForm'"
          *ngIf="step2Stage >= 5"
          title="Fotos"
          [disabled]="cardDisabled(5)"
          description="La primera foto será la principal. Las demás se verán en el detalle"
          [showFooter]="true"
          [continueDisabled]="selectedImages.length === 0 || cardDisabled(5)"
          (onCancel)="cancelStage()"
          (onContinue)="continueStage()"
        >
          <!-- Área de subida / preview -->
          <div
            class="photos-section"
            [class.has-images]="selectedImages.length > 0"
          >
            <div
              class="photo-upload-area"
              [class.has-images]="selectedImages.length > 0"
            >
              <!-- input oculto -->
              <input
                #fileInput
                type="file"
                accept="image/*"
                multiple
                class="file-input"
                (change)="onImagesSelected($event)"
              />

              <!-- prompt inicial -->
              <ng-container *ngIf="selectedImages.length === 0">
                <div class="upload-prompt" (click)="fileInput.click()">
                  <div class="upload-header">
                    <mat-icon>cloud_upload</mat-icon>
                    <p>Seleccionar uno o varias fotos aquí</p>
                  </div>
                  <small>Máx 5 fotos · JPG/PNG/WEBP · ≤ 5 MB</small>
                </div>
              </ng-container>

              <!-- grid de previews -->
              <div class="image-preview-grid" *ngIf="selectedImages.length > 0">
                <!-- miniaturas -->
                <div
                  class="image-preview-item"
                  *ngFor="let img of selectedImages; let i = index"
                >
                  <img [src]="img.preview" [alt]="'Imagen ' + (i + 1)" appDefaultImage />
                  <button
                    type="button"
                    mat-icon-button
                    class="remove-image"
                    (click)="removeImage(i)"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>

                <!-- cuadro “+” hasta llegar a 5 -->
                <button
                  type="button"
                  class="add-more-images"
                  *ngIf="selectedImages.length < 5"
                  (click)="fileInput.click()"
                >
                  <mat-icon>add</mat-icon>
                  <span>Agregar más</span>
                </button>
              </div>
            </div>
          </div>
        </app-publish-info>
      </form>
    </section>

    <!-- ========== PASO 3 ========== -->
    <div class="step-header" *ngIf="progress.currentStep === 3">
      <span class="step-indicator">Paso 3 de 3</span>
      <h1 class="step-title">
        Definí la información comercial de la publicación
      </h1>
    </div>
    <section *ngIf="progress.currentStep === 3">
      <form id="commercialForm" [formGroup]="commercialForm" class="commercial-form">
        <app-publish-info
          [formId]="'commercialForm'"
          title="Precio"
          description="Indicá el valor al que querés vender tu producto"
        >
          <app-form-field
            placeholder="0"
            prefixIcon="$"
            formControlName="price"
            [hasError]="hasError('commercial', 'price')"
            [errorMessage]="getError('commercial', 'price')"
          >
          </app-form-field>
        </app-publish-info>

        <app-publish-info
          [formId]="'commercialForm'"
          title="Medios de pago"
          description="Elegí las formas de pago que vas a aceptar"
        >
          <div class="payment-grid">
            <mat-checkbox formControlName="acceptsCash"
              ><p>Efectivo</p></mat-checkbox
            >
            <mat-checkbox formControlName="acceptsCard"
              ><p>Tarjeta</p></mat-checkbox
            >
            <mat-checkbox formControlName="acceptsTransfer"
              ><p>Transferencia</p></mat-checkbox
            >
            <mat-checkbox formControlName="acceptsBarter"
              ><p>Trueque</p></mat-checkbox
            >
          </div>
        </app-publish-info>

        <div class="publish-final">
          <button
            mat-raised-button
            color="accent"
            class="publish-button"
            (click)="publishListing()"
            [disabled]="isLoading"
          >
            <ng-container *ngIf="!isLoading; else loading">
              Publicar
            </ng-container>
            <ng-template #loading>
              <mat-progress-spinner
                diameter="24"
                mode="indeterminate"
                strokeWidth="3"
              ></mat-progress-spinner>
            </ng-template>
          </button>
        </div>
      </form>
    </section>
  </main>

  <app-footer></app-footer>
</div>
